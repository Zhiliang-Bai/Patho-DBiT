---
---
```{r LOADING LIBRARY, include=FALSE}
library(pacman)
pacman::p_load(Seurat, ggplot2, patchwork, dplyr, magrittr, data.table, OpenImageR, grid, utils, gridExtra, tidyr, raster, ggpubr, yarrr, plyr, knitr, imager, viridis, kableExtra, org.Hs.eg.db, tibble, clusterProfiler, DOSE, enrichplot, BuenColors)
knitr::opts_chunk$set(echo=TRUE)
knitr::knit_hooks$set(crop = knitr::hook_pdfcrop)
```

```{r LOADING DATA, message=FALSE, warning=FALSE, include=FALSE}
sample = "Sample_name"
dir = "Your path of the expression matrix: Sample_matrix"
setwd(dir)

expr_sample <-t(as.matrix(read.table("Sample_matrix.tsv")))
df<- read.table("Sample_matrix.tsv")
df_gname <- colnames(df)
df_gname_filter <- df_gname[!grepl('^(5S|5_8S|MT)',df_gname)] # Consider including additional non-essential genes for filtering, such as ribosomal genes.
df_gname_filter <- df[,df_gname_filter]
allZero_rows <- rowSums(df_gname_filter==0)==ncol(df_gname_filter)
df_gname_filter <- df_gname_filter[!allZero_rows,]
gname <- t(as.matrix(df_gname_filter))

# The output position file generated by 'Pixel_identification.m'.
pos_sample <-  fread("position.txt",header = F) %>% t 

pos_sample <- rbind(pos_sample, c("1x1"))
pos_sample <- rbind(pos_sample, c("50x50"))
pos_sample <- rbind(pos_sample, c("1x50"))
pos_sample <- rbind(pos_sample, c("50x25"))
pos_sample <- rbind(pos_sample, c("25x50"))
pos_sample <- rbind(pos_sample, c("50x1"))
pos_sample <- rbind(pos_sample, c("25x1"))
pos_sample <- rbind(pos_sample, c("1x25"))

pos_sample_df <-
  data.frame (pos = pos_sample) %>% filter(!is.na(pos)) %>% distinct() %>%
  mutate(
    xcoord = gsub('x.*$', '', pos) %>% as.numeric(),
    ycoord = gsub('.*x', '', pos)  %>% as.numeric()
  ) %>%
  set_rownames(.$pos) %>%
  dplyr::select(xcoord, ycoord)

tmp <- pos_sample_df$xcoord
pos_sample_df$xcoord <-  pos_sample_df$ycoord
pos_sample_df$ycoord <-  tmp

pos_cor <- expr_sample %>% colnames() %>%
  .[. %in%  rownames(pos_sample_df)] %>% as.character()

pos_cor2 <- gname %>% colnames() %>%
  .[. %in%  rownames(pos_sample_df)] %>% as.character()

pos_sample_df_cor <- pos_sample_df[pos_cor, ]
pos_sample_df_cor2 <- pos_sample_df[pos_cor2, ]
expr_sample_cor <- expr_sample[, pos_cor]
df_gname_filter_cor <- gname[, pos_cor2]


## Create Seurat object
# Object for visualizing gene and UMI number
samp <-
  CreateSeuratObject(counts = expr_sample_cor,
                     project = sample,
                     assay = 'Spatial')

samp$slice <- 1
samp$region <- sample

samp[[sample]] <- new(Class = 'SlideSeq', assay = "Spatial",coordinates = pos_sample_df_cor)

# Object for clustering analysis
samp2 <-
  CreateSeuratObject(counts = df_gname_filter_cor,
                     project = sample,
                     assay = 'Spatial')
samp2$slice <- 1
samp2$region <- sample

samp2[[sample]] <- new(Class = 'SlideSeq', assay = "Spatial",coordinates = pos_sample_df_cor2)

# Load the non-coding RNA expression matrix, such as microRNA data.
expr_sample_micro <- t(as.matrix(read.table("microRNA.tsv",row.names=1,header=TRUE)))
position <- colnames(samp2)
expr_sample_micro_cor <- expr_sample_micro[, position]

# Add microRNA into the Object
small_assay <- CreateAssayObject(counts = expr_sample_micro_cor)
samp2[["microRNA"]] <-small_assay

```

## Histogram of UMI/Gene per Pixel
```{r Histogram, dpi=150, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Distribution of UMI & Gene Counts per Pixel"}
dt1 <- data.table(count = rep("Gene Count", length(samp) ),
                    dist = samp$nFeature_Spatial )
  dt2 <- data.table(count = rep("UMI Count", length(samp) ),
                     dist = samp$nCount_Spatial)
  dt <- rbindlist( list( dt1, dt2 ) )
  mu <- ddply(dt, "count", summarise, grp.mean=mean(dist))
  plotA <-ggplot(dt, aes(x=dist, fill=count, color=count)) +
    geom_histogram(aes(y = ..density..), alpha=0.5, bins = 60) + 
    geom_density(alpha = 0) + 
    geom_vline(data=mu, aes(xintercept=grp.mean, color=count), linetype="dashed") + 
    scale_fill_manual(values = c("#084081","#CB181D")) +
    scale_color_manual(values = c("#084081","#CB181D")) +
    scale_x_continuous(breaks = seq(0, 10000, 1000), lim = c(0, 10000)) + 
    ggtitle("Counts") + theme(
      panel.grid.major.x = element_blank(),
      panel.grid.minor.x = element_blank(),
      panel.grid.major.y = element_blank(),
      panel.grid.minor.y = element_blank(),
      legend.title = element_blank(),
      axis.title.y = element_blank(),
      axis.text.y = element_blank(),
      axis.ticks.y = element_blank(),
      axis.title.x = element_blank(),
      legend.position = c(0.9,0.85)
    )

ggsave("Histogram_UMI-Gene.png", plot = plotA, path = dir, dpi = 600, bg = NULL)
knitr::include_graphics(paste0(dir,"/","Histogram_UMI-Gene.png"))
```

## DBiT_GS UMI Spatial Map
```{r UMI SPATIAL MAP, dpi=150, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Spatial UMI Heatmap Visualization"}
counts_Matrix <- t(samp[["Spatial"]]@data)
counts_Matrix2 <- as.data.frame(as.matrix(counts_Matrix))
count <- rowSums(counts_Matrix2[,1:ncol(counts_Matrix2)])
counts_Matrix2_bin <- counts_Matrix2[,1:ncol(counts_Matrix2)] %>% mutate_all(as.logical)
gene_count <- rowSums(counts_Matrix2_bin)
counts_Matrix2$X <- row.names(counts_Matrix2)
counts_Matrix2 <- counts_Matrix2 %>% separate(X, c("A","B"),sep="x")
#Adjust scale_color_gradientn(limits=c()) for each sample
plotB <- ggplot(counts_Matrix2, aes(x = as.numeric(A),  y = as.numeric(B),  color = count)) +
  scale_color_gradientn(colours = jdb_palette("brewer_spectra"),limits=c(0,10000),oob = scales::squish) +
  ggtitle("UMI Heatmap") + guides(colour = guide_colourbar(barwidth = 1, barheight = 15)) +
          geom_point(shape=16,size = 2.6, alpha = 1) +
          expand_limits(x = 0, y = 0) +
          scale_x_continuous(
            name = "X",limits = c(NA, NA), expand = expansion(mult = c(-0.013,-0.013))
          ) +
          scale_y_reverse(
            name = "Y", limits = c(NA, NA), expand = expansion(mult = c(-0.013, 0.008))
          ) +
          coord_equal(xlim = c(0, 51), ylim = c(51, 1)) +
          theme(plot.title = element_text(hjust = 0.5,size = 25,face = "bold"),
            axis.text = element_text(size = 20),
            axis.title = element_text(size = 20, face = "bold"),
            legend.text = element_text(size = 20),
            legend.title = element_blank(),
            #legend.title = element_text(colour="black", size=15, face="bold"),
            panel.grid.major = element_blank(),
            panel.grid.minor = element_blank(),
            panel.background = element_blank()
          ) + NoAxes()
ggsave("Spatial_UMImap.png", plot = plotB, path = dir, dpi = 600, bg = NULL)
knitr::include_graphics(paste0(dir,"/","Spatial_UMImap.png"))
```

## DBiT_GS Gene Spatial Map
```{r GENE SPATIAL MAP, echo=FALSE, message=FALSE, warning=FALSE, dpi=150, fig.cap="Spatial Gene Heatmap Visualization"}
plotC <- ggplot(counts_Matrix2, aes(x = as.numeric(A),  y = as.numeric(B),  color = gene_count)) +
  scale_color_gradientn(colours = jdb_palette("brewer_yes"),limits=c(0,5000),oob = scales::squish) +
  ggtitle("Gene Heatmap") + guides(colour = guide_colourbar(barwidth = 1, barheight = 15)) +
  geom_point(shape = 16, size = 2.6,alpha = 1) +
  expand_limits(x = 0, y = 0) +
  scale_x_continuous(
    name = "X",
    limits = c(NA, NA),
    expand = expansion(mult = c(-0.013, -0.013))
  ) +
  scale_y_reverse(
    name = "Y",
    limits = c(NA, NA),
    expand = expansion(mult = c(-0.013, 0.008))
  ) +
  coord_equal(xlim = c(0, 51), ylim = c(51, 1)) +
  theme(
    plot.title = element_text(
      hjust = 0.5,
      size = 25,
      face = "bold"
    ),
    axis.text = element_text(size = 20),
    axis.title = element_text(size = 20, face = "bold"),
    legend.text = element_text(size = 20),
    legend.title = element_blank(),
    #legend.title = element_text(colour="black", size=15, face="bold"),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    panel.background = element_blank()
  ) + NoAxes()
ggsave("Spatial_Genemap.png", plot = plotC, path = dir, dpi = 600, bg = NULL)
knitr::include_graphics(paste0(dir,"/","Spatial_Genemap.png"))
```

```{r NORMALIZE WITH SCTRANSFORM, echo=FALSE, message=FALSE, warning=FALSE}
DefaultAssay(samp2) <- "Spatial"
samp2@meta.data %<>% mutate(UMIs = nCount_Spatial)
samp2@meta.data %<>% mutate(Genes = nFeature_Spatial)
samp2 <- SCTransform(samp2, assay = "Spatial", verbose = FALSE)
samp2@meta.data %<>% mutate(UMIs_SCT = nCount_SCT)
samp2@meta.data %<>% mutate(Genes_SCT = nFeature_SCT)
```

```{r DIMENSIONAL REDUCTION AND CLUSTERING, echo=FALSE, message=FALSE, warning=FALSE}
samp2 <- RunPCA(samp2, assay = "SCT", verbose = FALSE)
ElbowPlot(samp2) # Determine the number of principal components (PCA) to include in the subsequent steps.
samp2 <- FindNeighbors(samp2, reduction = "pca", dims = 1:10)
samp2 <- FindClusters(samp2, resolution = 0.8)
samp2 <- RunUMAP(samp2, reduction = "pca", dims = 1:10)
```

# Unsupervised Clustering Analysis {.tabset}

## UMAP
```{r VISUALIZATION OF CLUSTERING, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="UMAP Clustering of Pixels"}
# Load color scheme for clustering
alphabet = c('0' = '#72A2C0', '1' = '#F2917D', '2' = '#BC589B', '3' = '#7F7F7F', '4' = '#ABDDDE', '5' = '#FDD262', '6'='#EB545C','7'='#00475F', '8' = '#FFFF0A','9' = '#D7EF9B','10' = '#9E0142','11' = '#F2A104','12' = '#289E92','13' = '#80FF08')
plotD <- DimPlot(samp2, reduction = "umap") + scale_color_manual(values = alphabet[1:(samp2@active.ident %>% unique %>% length )])
ggsave("UMAP.png", plot = plotD, path = dir, dpi = 600, bg = NULL)
knitr::include_graphics(paste0(dir,"/","UMAP.png"))
```

## Spatial UMAP
```{r SPATIAL CLUSTERING, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Clusters Spatially Organized" }
plotE <- SpatialDimPlot(samp2, label.size = 3, pt.size = 5,cols = alphabet[1:(samp2@active.ident %>% unique %>% length )], stroke = 0) &
  scale_x_continuous(name="X",expand = expansion(mult = c(0.008, 0.008))) &
  scale_y_continuous(name="Y",expand = expansion(mult = c(0.008, 0.008))) &
  theme(legend.position = "right", plot.background =  element_rect(fill = "transparent", color=NA),panel.grid.major = element_blank(), panel.grid.minor = element_blank())
ggsave("SpatialUMAP.png", plot = plotE, path = dir, dpi = 600, bg = "transparent")
knitr::include_graphics(paste0(dir,"/","SpatialUMAP.png"))
```

## Individual Spatial UMAP
```{r VISUALIZE INDIVDUAL CLUSTERS SPATIALLY, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="Clusters Visualized Individually"}
plotF <- SpatialDimPlot(
  samp2,
  cells.highlight = CellsByIdentities(object = samp2, idents = c(0)), # Choose cluster to present
  facet.highlight = TRUE,
  pt.size.factor = 5,
  stroke = 0,
  cols.highlight = c('#72A2C0', 'grey80')
)

ggsave("IndUMAP_Cluster0.png", plot = plotF, path = dir, dpi = 600, bg = NULL)
knitr::include_graphics(paste0(dir,"/","IndUMAP_Cluster0.png"))
```

## DEGs Heatmap
```{r GENE EXPRESSION MARKER HEATMAP, echo=FALSE, fig.cap="Heatmap, message=FALSE, warning=FALSE}
samp.markers<- FindAllMarkers(samp2,assay="SCT",logfc.threshold = 0)
samp.markers.top6<- samp.markers %>% group_by(cluster) %>% top_n(wt = avg_log2FC , n = 6 )
plotG <- DoHeatmap(samp2, features = samp.markers.top6$gene)+ theme(axis.text=element_text(size=5))+ scale_fill_gradientn(colors=c("#192E5B","#1D65A6","#72A2C0","#F3E96B","#F2A104"))
ggsave("DEGs_Heatmap.png", plot = plotG, path = dir, dpi = 600, bg = NULL)
knitr::include_graphics(paste0(dir,"/","DEGs_Heatmap.png"))
```

## Module Score Expression
```{r GENE EXPRESSION MARKER HEATMAP, echo=FALSE, fig.cap="MArkergene, message=FALSE, warning=FALSE}
Bcelllist <- list(c("CD74","CD19","MS4A1"))
Plasmalist <- list(c("IGKC","IGLC3","IGHA1","IGHG1"))
Mucuslist <- list(c("GKN1","MUC5AC","TFF1","PSCA"))
Macrophagelist <- list(c("LYZ","CXCL3","CXCL3"))

samp2 <- AddModuleScore(object = samp2, features = Bcelllist, name = "Bcelllist")
samp2 <- AddModuleScore(object = samp2, features = Plasmalist, name = "Plasmalist")
samp2 <- AddModuleScore(object = samp2, features = Smoothlist, name = "Mucuslist")
samp2 <- AddModuleScore(object = samp2, features = Macrophagelist, name = "Macrophagelist")

plotH <- SpatialFeaturePlot(samp2, features = "Bcelllist1",min.cutoff = "q05", max.cutoff ="q95",alpha=c(0.1,1),pt.size.factor=3.5)+ ggplot2::scale_fill_gradientn(colors=c('#F7FCF0', '#E0F3DB', '#CCEBC5', '#A8DDB5', '#7BCCC4', '#4EB3D3', '#2B8CBE', '#0868AC', '#084081'))
ggsave("B-cell_Module_Score.png", plot = plotH, path = dir, dpi = 600, bg = NULL)
knitr::include_graphics(paste0(dir,"/","B-cell_Module_Score.png"))

```

## Non-coding RNA analysis, for example, microRNA
```{r Cell Type Marker Genes, echo=FALSE, message=FALSE, warning=FALSE, fig.show='hold',out.width="33%",out.height="33%", fig.cap="Normalized Expression of Specific Genes"}
DefaultAssay(samp2) <- "microRNA"
samp2 <- NormalizeData(samp2)
plotI <- SpatialFeaturePlot(samp2, features = "MIR143--miRNA",alpha=c(0.1,1),min.cutoff = "q05", max.cutoff = "q95",pt.size.factor=2.5)+ ggplot2::scale_fill_gradientn(colors=c('#FFF7F3', '#FDE0DD', '#FCC5C0', '#FA9FB5', '#F768A1', '#DD3497', '#AE017E', '#7A0177', '#49006A'))

ggsave("MIR143_expression.png", plot = plotI, path = dir, dpi = 600, bg = NULL)
knitr::include_graphics(paste0(dir,"/","MIR143_expression.png"))
```

